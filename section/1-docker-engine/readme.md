

### Troubleshooting Docker Daemon

**check the docker host** \
it's possible to have the docker cli running on your laptop and the docker engine is running on a remote server \
in that case, define the DOCKER_HOST variable in your terminal:
```
export DOCKER_HOST="tcp://192.168.1.10:2376 # port 2375 for unencrypted traffic
export DOCKER_HOST="tcp://192.168.1.10:2376 # port 2376 for encrypted traffic
docker ps # to test docker 
```

**Check Service Status** \
docker should run as a background service so that when you boot up the service is started \
check the status with the following command:
```
systemctl status docker
```

**View Logs**
if the status is 'dead' you can check the logs to get more information:
```
journalctl -u docker.service 
```

**Daemon Configuration File**
another place to check is the daemon configuration file 
```
sudo cat /etc/docker/daemon.json
```
 - The default config file path on Linux is /etc/docker/daemon.json, but it doesn't exist by default. You can write one yourself and put additional docker daemon configuration stuff in there instead of passing in those configuration options into the command line. You don't even have to do dockerd --config-file /etc/docker/daemon.json since that's the default path, but it can be useful to make it explicit for others who are inspecting the system.
 - Also ensure that any configuration you set in /etc/docker/daemon.json doesn't conflict with options passed into the command line evocation of dockerd.

**Check Disk Space on Host**
run this command and check /dev/sda*
```
df -h
```
- unused docker images or containers could be eating up all your space

delete all unused containers:
```
docker container prune
```

delete all unused images:
```
docker image prune
```

**Debug in Docker** \
if the docker service is up, view information about the system:
```
docker system info
```

view events on the system that may have lead to the issue:
```
docker events info
```

### Demo - Docker Debug Mode
NOTE: Ubuntu no longer uses the /var/log/messages file by default. The same information is available in the file /var/log/syslog.
by default, debug mode is set to false \
when you create a container, you'll find logs stashed in **/var/docker/logs/messages** -or- **/var/log/syslog** (ubuntu) \

create a container and view the logs (ubuntu):
```
docker container run -itd --name=test httpd:latest && tail -30 /var/log/syslog
```
- high level overview logs are generated by default, **these are not debug logs**
- to get debug logs, debug mode must be set to true 

**enable docker debug mode for a container**
when you want troubleshoot docker, you'll want debug mode enabled: 
```
sudo echo -e '{\n  "debug":true\n}' >> /etc/docker/daemon.json
```

reload docker services after applying these changes:
```
sudo systemctl reload docker
```

confirm Debug Mode is now set to true:
```
docker system info
```

create a container:
```
docker container run -itd --name=test httpd:latest
```

check the last 50 log entries (ubuntu):
```
tail -50 /var/log/syslog
```

set debug mode to false and restart the docker service after troubleshooting:
```
sudo echo -e '{\n  "debug":false\n}' > /etc/docker/daemon.json ; sudo systemctl reload docker 
```

**additional documentation** \
[offical documentation](https://docs.docker.com/engine/reference/commandline/logs/) \
[how can I debug a docker container initialization?](https://serverfault.com/questions/596994/how-can-i-debug-a-docker-container-initialization)

### Logging Driver
we know how to get specfic logs from a container from the CLI:
```
docker logs nginx
```
- but where are these logs stored on the docker host?
- the logging driver defines wheres logs are stored, run `docker system info` and review the 'Logging Driver' key
- all containers use this driver by default

**viewing the default container log file** \
first get the id of the container:
```
docker ps
```

change dir and list containers by id:
```
cd /var/lib/docker/containers; ls
```

change to the container id dir and view *-json.log:
```
cat *-json.log
```

**log driver options** \
there are several places you can push your docker container logs, `docker system info` reveals the available plugins:
```
Server:
 Containers: 8
  Running: 1
  Paused: 0
  Stopped: 7
 Images: 56
 Server Version: 20.10.5
 Storage Driver: overlay2
  Backing Filesystem: extfs
  Supports d_type: true
  Native Overlay Diff: true
 Logging Driver: json-file
 Cgroup Driver: cgroupfs
 Cgroup Version: 1
 Plugins:
  Volume: local
  Network: bridge host ipvlan macvlan null overlay
  Log: awslogs fluentd gcplogs gelf journald json-file local logentries splunk syslog
```
- awslogs pushs to cloudwatch logs
- gcplogs pushs to google cloud platform's cloudwatch alternative  

if you want to push container logs to aws, you would edit **etc/docker/daemon.json**
```
{
  "debug": true,
  "log-driver": "awslogs",
  "log-opt": {
      "awslogs-region": "us-east-1"
  }
}
```

additional parameters are need for aws cloudwatch (region must be defined) \
you also need to provide credentials to your aws account, this can be done with environment variables or a credentials file:
```
export AWS_ACCESS_KEY_ID=<>
export AWS_SECRET_ACCESS_KEY=<>
export AWS_SESSION_TOKEN=<>
```

you can override the logging driver in the command line when running a container:
```
docker run -d --log-driver json-file nginx
```

use the inspect command to verify the logging driver \
`docker container inspect nginx`
```
...
        "HostConfig": {
            "Binds": [],
            "ContainerIDFile": "",
            "LogConfig": {
                "Type": "json-file",
                "Config": {}
            },
```
you can also filter the logging driver with a json path expression:
```
docker container inspect -f '{{.HostConfig.LogConfig.Type}}' nginx
```



**.**
.
```
.
```
- 
**.**
.
```
.
```
- 
**.**
.
```
.
```
- 
**.**
.
```
.
```
- 